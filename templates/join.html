<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beitreten</title>

    <!-- üü£ PWA-Integration -->
    <link rel="apple-touch-icon" href="/static/img/icon_512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/img/icon_192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/img/icon_512.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#000129">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/serviceWorker.js')
          .then(() => console.log("‚úÖ Service Worker aktiv"))
          .catch(err => console.error("‚ùå SW Fehler:", err));
      }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000129; /* üíô Neuer Hintergrund */
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* üñº Banner-Styling */
        #banner-container {
            text-align: center;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        #banner {
            max-width: 90%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        h1 { font-size: clamp(1.5rem, 5vw, 2.2rem); }

        input[type="text"] {
          font-size: 16px;
          padding: 10px;
          border-radius: 8px;
          width: 80%;
          max-width: 300px;
          border: none;
          outline: none;
          margin-bottom: 12px;
        }

        button {
          background-color: #1E1F5C;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
        }

        button:hover { background-color: #2B2C6E; }

        #waitingRoom { margin-top: 20px; font-size: 1rem; }
    </style>
</head>
<body>

    <!-- üñº Banner ganz oben -->
    <div id="banner-container">
        <img src="{{ url_for('static', filename='img/banner.png') }}" alt="Das gro√üe Assoziationsspiel" id="banner">
    </div>  

<h1>Spiel beitreten</h1>

<div id="formContainer">
    <p>Bitte gib deinen Namen ein:</p>
    <form id="nameForm">
        <input type="text" id="playerName" placeholder="Dein Name" required>
        <button type="submit">Beitreten</button>
    </form>
</div>

<div id="waitingRoom" style="display:none;">
    <p id="playerCount">Warte auf andere Spieler...</p>
</div>

<script>
    // Falls kein Name im Speicher -> niemals auto-beitreten
    if (!localStorage.getItem("player_name")) {
        localStorage.removeItem("player_sid");
    }

    const serverGameId = "{{ game_id }}";
    const storedGameId = localStorage.getItem("game_id");

    if (storedGameId !== serverGameId) {
        console.log("üßπ Neues Spiel erkannt ‚Äì Speicher wird gel√∂scht (join.html)");
        localStorage.clear();
        localStorage.setItem("game_id", serverGameId);
    } else {
        console.log("‚úÖ Gleiches Spiel ‚Äì Speicher bleibt bestehen (join.html)");
    }
    
    const socket = io({
        withCredentials: true,
        transports: ['websocket', 'polling']
    });

    socket.on("server_game_id", data => {
        const serverId = data.game_id;
        const storedId = localStorage.getItem("game_id");
        if (storedId && storedId !== serverId) {
            console.log("‚ö†Ô∏è Neues Spiel erkannt (Server-Neustart oder Reset).");
            alert("Das Spiel wurde beendet. Bitte starte ein neues Spiel.");
            localStorage.clear();
            localStorage.setItem("game_id", serverId);
            window.location.href = "/";
        }
        });

    // Falls Spielername bereits gespeichert ist, automatisch wiederbeitreten
    const savedName = localStorage.getItem("player_name");
    const savedSid  = localStorage.getItem("player_sid");

    socket.on("connect", () => {
        localStorage.setItem("player_sid", socket.id);
    });

    // Name nur vorbef√ºllen, Nutzer muss aktiv beitreten
    if (savedName) {
        document.getElementById('playerName').value = savedName;
    }

    document.getElementById('nameForm').onsubmit = e => {
        e.preventDefault();
        const name = document.getElementById('playerName').value.trim();
        if (!name) return;
        localStorage.setItem("player_name", name);
        socket.emit('join_game', { name });
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'block';
    };

    socket.on('player_count', data => {
        document.getElementById('playerCount').innerHTML =
            `Warte auf andere Spieler... (${data.current_players}/${data.max_players})<br>` +
            `Beigetreten: ${data.names.join(', ')}`;
    });

    socket.on('start_game', data => {
        window.location.href = '/play';
    });

    socket.on('game_full', () => {
        alert("Das Spiel ist bereits voll.");
        window.location.href = '/full';
    });
</script>
</body>
</html>
